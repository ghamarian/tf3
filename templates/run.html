{% extends "base_tf3.html" %}
{% import 'bootstrap/wtf.html' as wtf %}
{% from '_render_field.html' import render_field, render_single_field %}

{% block scripts %}
    {{ super() }}
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.16/sl-1.2.5/datatables.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.min.js"></script>
    <script type=text/javascript>
        $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    </script>



    <script>
        var output = document.getElementById('log');

        var xhr = new XMLHttpRequest();
        xhr.open('GET', '{{ url_for('stream') }}');
        xhr.send();

        setInterval(function () {
            output.textContent = xhr.responseText;
            console.log(xhr.responseText);
            $('#log').scrollTop($('#log')[0].scrollHeight);
        }, 1000);
    </script>


    <script type="text/javascript">
        var handle_key = {};
        handle_key.features = {{ features | tojson | safe }};
        handle_key.types = {{ types | tojson | safe }};
        handle_key.categoricals = {{ categoricals | tojson | safe }};
        handle_key.checkpoints = {{ checkpoints | tojson | safe }};
        $.each(handle_key.features, function (key, value) {
            if (handle_key.types[key] == "number") {
                $('#maindiv').append('<tr> <th>' + key + ' </th> <th>')
                $('#maindiv').append('<input type="' + handle_key.types[key] + '" name ="' +
                    key + '" value="' + value + '"  step="0.001"> </th></tr> ');
            }
            ;
        });
        $.each(handle_key.categoricals, function (key, value) {
            var i;
            var len = handle_key.categoricals[key].length;
            $('#maindiv').append('<tr> <th>' + key + ' </th> <th>');
            $('#maindiv').append('<select id="' + key + '" name="' + key + '"> </select>');
            $('#maindiv').append('</th></tr>');
            for (i = 0; i < len; i++) {
                $('#' + key).append(new Option(handle_key.categoricals[key][i], handle_key.categoricals[key][i]));
            }
        });
        $.each(handle_key.checkpoints, function (key, value) {
            $('#tablediv').append('<tr>')
            $('#tablediv').append('<td> <input type="radio" id="radiob" name="radiob" value="' + key + '">' + key);
            $('#tablediv').append('<td> ' + value['accuracy']);
            $('#tablediv').append('<td> ' + value['loss']);
            $('#tablediv').append('<td> <a data-id=' + key + ' onclick="ConfirmDelete(this)" ><span class="glyphicon glyphicon-remove"></span></a> </tr>');

        });

        $(document).ready(function () {
            $('#tablediv').on('click change', 'input:radio[name="radiob"]', function () {
                $('#predict_button').prop('disabled', false);
                $('#defaultCheck2').prop('disabled', false);
            });

        });

        function hidde_show() {
            var x = document.getElementById("log");
            if (x.style.display === "none") {
                x.style.display = "block";
                $('#detail_gly').removeClass('glyphicon-triangle-bottom').addClass('glyphicon-triangle-top');
            } else {
                x.style.display = "none";
                $('#detail_gly').removeClass('glyphicon-triangle-top').addClass('glyphicon-triangle-bottom');

            }
        }


    </script>
    <script>
        function ConfirmDelete(elem) {
            if (confirm("Are you sure you want to delete the selected model?")){
                $.ajax({
                        url: "{{ url_for('delete', _external=True) }}",
                        type: 'POST',
                        dataType: 'json',
                        contentType: 'application/json;charset=UTF-8',
                        accepts: {
                            json: 'application/json',
                        },
                        data: JSON.stringify({'deleteID': $(elem).attr('data-id')}),
                        success: function (data) {
                            var $radios = $('input[name="radiob"]');
                            var $selected = $radios.filter(':checked');
                            if ($selected.val() && $selected.val() != $(elem).attr('data-id')) {
                                $('#predict_button').prop('disabled', false);
                                $('#defaultCheck2').prop('disabled', false);
                            } else {
                                $('#predict_button').prop('disabled', true);
                                $('#defaultCheck2').prop('disabled', true);
                            }
                            $('#tablediv').empty();

                            $.each(data.checkpoints, function (key, value) {
                                var checked = '';
                                if (key == $selected.val()) {
                                    checked = 'checked';
                                }
                                $('#tablediv').append('<tr>');
                                $('#tablediv').append('<td> <input type="radio" id="radiob" name="radiob" value="' + key + '" ' + checked + '>' + key);
                                $('#tablediv').append('<td> ' + value['accuracy']);
                                $('#tablediv').append('<td> ' + value['loss']);
                                $('#tablediv').append('<td> <a data-id=' + key + ' onclick="ConfirmDelete(this)" ><span class="glyphicon glyphicon-remove"></span></a> </tr>');

                            });
                        }

                    })
            }
        }

        function ConfirmDeleteAll(elem) {

            if (confirm("Are you sure you want to delete all saved models?")){
                $.ajax({
                        url: "{{ url_for('delete', _external=True) }}",
                        type: 'POST',
                        dataType: 'json',
                        contentType: 'application/json;charset=UTF-8',
                        accepts: {
                            json: 'application/json',
                        },
                        data: JSON.stringify({'deleteID': $(elem).attr('data-id')}),
                        success: function (data) {
                            $('#tablediv').empty();
                            $('#predict_button').prop('disabled', true);
                            $('#defaultCheck2').prop('disabled', true);
                        }
                    })
            }
        }
    </script>
    <script>
        $(document).ready(function () {
            setInterval(function () {
                $.ajax({
                    url: "{{ url_for('refresh', _external=True) }}",
                    type: 'GET',
                    dataType: 'json',
                    contentType: 'application/json;charset=UTF-8',
                    accepts: {
                        json: 'application/json',
                    },
                    data: JSON.stringify("checkpoints"),
                    success: function (data) {
                        var $radios = $('input[name="radiob"]');
                        var $selected = $radios.filter(':checked');
                        if ($selected.val()) {
                            $('#predict_button').prop('disabled', false);
                            $('#defaultCheck2').prop('disabled', false);
                        } else {
                            $('#predict_button').prop('disabled', true);
                            $('#defaultCheck2').prop('disabled', true);
                        }
                        $('#tablediv').empty();

                        $.each(data.checkpoints, function (key, value) {
                            var checked = '';
                            if (key == $selected.val()) {
                                checked = 'checked';
                            }
                            $('#tablediv').append('<tr>');
                            $('#tablediv').append('<td> <input type="radio" id="radiob" name="radiob" value="' + key + '" ' + checked + '>' + key);
                            $('#tablediv').append('<td> ' + value['accuracy']);
                            $('#tablediv').append('<td> ' + value['loss']);
                            $('#tablediv').append('<td> <a data-id=' + key + ' onclick="ConfirmDelete(this)" ><span class="glyphicon glyphicon-remove"></span></a> </tr>');

                        });
                    }
                })

            }, 10000)
        });
    </script>
    <script>
        $("#predict_button").click(function (e) {
            $.ajax({
                url: "{{ url_for('predict', _external=True) }}",
                type: 'POST',

                data: $("#predict_form").serialize(),
                success: function (data) {
                    if (data.prediction == 'None'){
                        alert('Model\'s structure does not match the new parameter configuration')
                    }else{
                        $('#predict_val').text(data.prediction)
                    }

                }

            })
        });
    </script>
    <script>
        $("#run_button").click(function (e) {
            var form_data = {'action': 'pause'}

            if (document.getElementById("run_button").className == 'play') {
                form_data['action'] = 'run';
            };
            if (document.getElementById("defaultCheck2").checked == true) {
                var $radios = $('input[name="radiob"]');
                var $selected = $radios.filter(':checked');

                form_data['resume_from'] = $selected.val();
            };
            $.ajax({
                url: "{{ url_for('run', _external=True) }}",
                type: 'POST',
                data: form_data,
                success: function () {
                    $('.play').toggleClass('active');
                }
            })
        });
    </script>

{% endblock %}


{% block styles %}
    {{ super() }}
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/v/dt/dt-1.10.16/sl-1.2.5/datatables.min.css"/>
{% endblock %}

{% block app_content %}

    {#    <meta http-equiv="refresh" content="60"/>#}
    {#    <div class="bs-callout bs-callout-default">#}
    <div class="center-block">
        <form id="run_form" method="post">
            <button type="button" formmethod="post" id="run_button" name="run_button" class="play">

            </button>
            <h1>Training Play/Pause </h1>
            <span class="headline">click/touch the button to train your model.</span>
        </form>
        <a role="button" name="tensor" class="btn btn-warning" target="_blank"
           href="http://localhost:{{ port }}"><span class="glyphicon glyphicon-blackboard"></span> TensorBoard</a>
        {#    </div>#}
    </div>

    <div class="bs-callout bs-callout-warning" align="center">
        <th2> PREDICT</th2>
        <form action="/predict" method="post" id="predict_form">
            <div class="container">
                <div class="row">
                    <div class="col-md-3">
                        <div class="bs-callout bs-callout-primary">
                            <h4><span class="glyphicon glyphicon-pencil"></span></h4>
                            <h4>FEATURES VALUES </h4>
                            Add new feature values.
                            <br> <br>
                            <div class="pre-scrollable">
                                <table>
                                    <div id="maindiv"></div>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="bs-callout bs-callout-info">
                            <h4><span class="glyphicon glyphicon-tasks"></span></h4>
                            <h4> CHECKPOINTS</h4>
                            Select trained model
                            <br>
                            <table class="table table-striped">
                                <thead>
                                <tr>
                                    <th scope="col">Model</th>
                                    <th scope="col">Accuracy</th>
                                    <th scope="col">Loss</th>
                                    <th scope="col"></th>
                                </tr>
                                </thead>
                                <div class="pre-scrollable">
                                    <tbody id="tablediv">
                                    </tbody>
                                </div>
                                <tfoot align="right">
                                <tr>
                                    <td colspan="4">Clear all models <a data-id=all onclick="ConfirmDeleteAll(this)">
                                        <span class="glyphicon glyphicon-trash" style="color:red"></span></a>
                                    </td>
                                </tr>

                                </tfoot>

                            </table>

                            <div align="left" >
                                <label class="checkbox-inline">
                                    <input  type="checkbox" value="" id="defaultCheck2" disabled> Resume training from selected model
                                </label>


                            </div>

                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="bs-callout bs-callout-success">
                            <h4><span class="glyphicon glyphicon-ok"></span></h4>
                            <h4> PREDICT</h4>
                            Get the predict value for your feature values
                            <br>
                            <h3>{{ target }} : <b>
                                <div id="predict_val"></div>
                            </b></h3>
                            <button type="button" id="predict_button" class="btn btn-primary" disabled>
                                PREDICT
                            </button>

                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>



    <button class="btn btn-link btn-details" onclick="hidde_show()">
        <span id="detail_gly" class="glyphicon glyphicon-triangle-bottom"></span> Details
    </button>
    <div id="log" class="log"></div>


    <div class="alert alert-{{ category }} alert-dismissible" role="alert">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span
                aria-hidden="true">&times;</span></button>
        <!-- <strong>Title</strong> --> {{ message }}
    </div>


{% endblock %}